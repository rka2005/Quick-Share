<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Share</title>
    <link rel="icon" type="image/png" href="quick-share.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loaderContainer" class="loader-container hidden">
        <div class="book">
            <div class="book__pg-shadow"></div>
            <div class="book__pg"></div>
            <div class="book__pg book__pg--2"></div>
            <div class="book__pg book__pg--3"></div>
            <div class="book__pg book__pg--4"></div>
            <div class="book__pg book__pg--5"></div>
        </div>
    </div>

    <div class="container">
        <div class="theme-switcher-container">
            <label class="switch">
                <input id="themeToggle" type="checkbox">
                <div class="slider round">
                    <div class="sun-moon">
                        <svg id="moon-dot-1" class="moon-dot" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50"></circle></svg>
                        <svg id="moon-dot-2" class="moon-dot" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50"></circle></svg>
                        <svg id="moon-dot-3" class="moon-dot" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50"></circle></svg>
                    </div>
                    <div class="stars">
                        <svg id="star-1" class="star" viewBox="0 0 20 20"><path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path></svg>
                        <svg id="star-2" class="star" viewBox="0 0 20 20"><path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path></svg>
                        <svg id="star-3" class="star" viewBox="0 0 20 20"><path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path></svg>
                        <svg id="star-4" class="star" viewBox="0 0 20 20"><path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path></svg>
                    </div>
                </div>
            </label>
        </div>

        <div class="header">
            <h1>Quick Share</h1>
            <p>Share text snippets and files securely and ephemerally.</p>
        </div>

        <div id="contentView" class="hidden"></div>
        <div id="initialView">
            <div id="retrieveSection">
                <form id="retrieveForm">
                    <input type="text" id="codeInput" placeholder="Enter share code..." required style="text-transform: uppercase;">
                    <button type="submit">Get Content</button>
                </form>
                <div id="retrieveResult" class="hidden"></div>
            </div>
            <div id="shareSection" class="section">
                <form id="uploadForm">
                    <textarea id="textContent" name="text_content" rows="5" placeholder="Paste text snippet here..."></textarea>
                    <div id="dropZone" class="drop-zone">
                        <p><strong>Drag & drop a file here</strong> or click to select</p>
                        <input type="file" id="fileInput" name="file" class="hidden" multiple>
                    </div>
                    <button id="generateBtn" type="submit" style="margin-top: 20px;">Generate Code</button>
                    <button id="updateBtn" type="button" class="hidden" style="margin-top: 20px;" disabled>Update Text</button>
                </form>
                <div id="uploadResult" class="hidden"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "https://quick-share-xwhs.onrender.com";
        // ✨ --- 3. JAVASCRIPT FOR LOADER & THEME --- ✨
        const loaderContainer = document.getElementById('loaderContainer');
        const themeToggle = document.getElementById('themeToggle');

        // Loader functions
        const showLoader = () => loaderContainer.classList.remove('hidden');
        const hideLoader = () => loaderContainer.classList.add('hidden');

        // Loader on page load
        document.addEventListener('DOMContentLoaded', () => {
            showLoader();
        });

        window.addEventListener('load', () => {
            hideLoader();
        });

        // Loader during async operations
        async function handleAsyncOperation(asyncFunc) {
            try {
                showLoader();
                await asyncFunc();
            } catch (err) {
                console.error(err);
            } finally {
                hideLoader();
            }
        }
        // Theme functions
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggle.checked = true;
            } else {
                document.body.classList.remove('dark-theme');
                themeToggle.checked = false;
            }
        };
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        
        // --- The rest of your original JavaScript is below ---
        
        const initialView = document.getElementById('initialView');
        const contentView = document.getElementById('contentView');
        const retrieveForm = document.getElementById('retrieveForm');
        const codeInput = document.getElementById('codeInput');
        const retrieveResult = document.getElementById('retrieveResult');
        const uploadForm = document.getElementById('uploadForm');
        const uploadResult = document.getElementById('uploadResult');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const textContent = document.getElementById('textContent');
        const generateBtn = document.getElementById('generateBtn');
        const updateBtn = document.getElementById('updateBtn');
        
        let currentCode = null;
        let originalText = "";

        function showInitialView() {
            initialView.classList.remove('hidden');
            contentView.classList.add('hidden');
            contentView.innerHTML = '';
            retrieveResult.classList.add('hidden');
            uploadResult.classList.add('hidden');
            codeInput.value = '';
            
            currentCode = null;
            originalText = "";
            uploadForm.reset();
            generateBtn.classList.remove('hidden');
            updateBtn.classList.add('hidden');
            dropZone.classList.remove('hidden');
            dropZone.querySelector('p').textContent = 'Drag & drop a file here or click to select';
        }
        
        function showContentView() {
            initialView.classList.add('hidden');
            contentView.classList.remove('hidden');
        }

        function showMessage(element, message, isError = false) {
            element.innerHTML = `<div class="result-message ${isError ? 'result-error' : 'result-success'}">${message}</div>`;
            element.classList.remove('hidden');
        }
        
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;

                const fileNames = Array.from(e.dataTransfer.files).map(f => f.name).join(', ');
                dropZone.querySelector('p').textContent = `${fileNames} selected`;

                textContent.value = ""; 
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                const fileNames = Array.from(fileInput.files).map(f => f.name).join(', ');
                dropZone.querySelector('p').textContent = `${fileNames} selected`;
                textContent.value = "";
            }
        });
        
        retrieveForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const code = codeInput.value.trim().toUpperCase();
            if (!code) return;

            handleAsyncOperation(async () => {
                showMessage(retrieveResult, 'Searching...');
                try {
                    const response = await fetch(`${API_BASE_URL}/find_file/${code}`);
                    if (!response.ok) throw new Error('Code not found. Please check and try again.');
                    const data = await response.json();
                    hideLoader();
                    showContentView();
                    if (data.type === 'text') {
                        const copyBtn = document.createElement('button');
                        copyBtn.textContent = 'Copy Text';
                        copyBtn.className = 'button copy-button';
                        copyBtn.addEventListener('click', () => {
                            navigator.clipboard.writeText(data.content).then(() => {
                                copyBtn.textContent = 'Copied!';
                                setTimeout(() => { copyBtn.textContent = 'Copy Text'; }, 2000);
                            });
                        });
                        contentView.appendChild(copyBtn);
                        const pre = document.createElement('pre');
                        pre.textContent = data.content;
                        contentView.appendChild(pre);
                    } else if (data.type === 'file') {
                        const fileUrl = `${API_BASE_URL}/get/${data.filename}`;
                        const ext = data.filename.split('.').pop().toLowerCase();

                        contentView.innerHTML = `<h1>File Preview</h1><p><strong>${data.filename}</strong></p>`;

                        if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                            const img = document.createElement('img');
                            img.src = fileUrl;
                            img.style.maxWidth = "100%";
                            img.style.borderRadius = "10px";
                            img.style.marginBottom = "20px";
                            contentView.appendChild(img);
                        } else if (ext === "pdf") {
                            const embed = document.createElement('embed');
                            embed.src = fileUrl;
                            embed.type = "application/pdf";
                            embed.width = "100%";
                            embed.height = "500px";
                            contentView.appendChild(embed);
                        } else if (["txt", "md"].includes(ext)) {
                            const res = await fetch(fileUrl);
                            const text = await res.text();
                            const pre = document.createElement('pre');
                            pre.textContent = text;
                            pre.style.background = "#f8f8f8";
                            pre.style.padding = "10px";
                            pre.style.borderRadius = "8px";
                            contentView.appendChild(pre);
                        } else {
                            const info = document.createElement('p');
                            info.textContent = "Preview not available for this file type.";
                            contentView.appendChild(info);
                        }

                        const downloadBtn = document.createElement('a');
                        downloadBtn.href = fileUrl;
                        downloadBtn.textContent = 'Download File';
                        downloadBtn.setAttribute('download', '');
                        downloadBtn.classList.add('button');
                        downloadBtn.style.marginTop = "15px";
                        contentView.appendChild(downloadBtn);
                    }

                    // ✅ BACK BUTTON (same)
                    const backBtn = document.createElement('button');
                    backBtn.textContent = 'Share or Get Another';
                    backBtn.className = 'button button-secondary';
                    backBtn.style.marginTop = '20px';
                    backBtn.onclick = showInitialView;
                    contentView.appendChild(backBtn);
                } catch (error) {
                    showMessage(retrieveResult, error.message, true);
                }
            });
        });

        textContent.addEventListener('input', () => {
            if (currentCode) {
                const isModified = textContent.value !== originalText;
                updateBtn.disabled = !isModified;
            }
            if(textContent.value) {
                fileInput.value = '';
                dropZone.querySelector('p').textContent = 'Drag & drop a file here or click to select';
            }
        });
        
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(uploadForm);
            
            if (!formData.get('text_content') && !formData.get('file')?.name) {
                showMessage(uploadResult, 'Please add text or a file to share.', true);
                return;
            }
            
            handleAsyncOperation(async () => {
                // ✅ Multiple files
                if (fileInput.files.length > 1) {
                    showMessage(uploadResult, 'Uploading multiple files...');
                    const multiFormData = new FormData();
                    for (let i = 0; i < fileInput.files.length; i++) {
                        multiFormData.append('files', fileInput.files[i]);
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/upload_multiple`, {
                            method: 'POST',
                            body: multiFormData,
                        });
                        if (!response.ok) throw new Error('Multiple file upload failed!');
                        const data = await response.json();
                        hideLoader();

                        const viewUrl = `${API_BASE_URL}/view/${data.code}`;
                        const fileList = data.files.map(f => `<li>${f}</li>`).join('');
                        const successMessage = `
                            <p>✅ Uploaded <strong>${data.files.length}</strong> files successfully! Your code is:</p>
                            <h2 style="letter-spacing: 2px;">${data.code}</h2>
                            <ul>${fileList}</ul>
                            <a href="${viewUrl}" target="_blank">Open Sharable Link</a>
                        `;
                        showMessage(uploadResult, successMessage);
                        uploadForm.reset();
                        dropZone.querySelector('p').textContent = 'Drag & drop a file here or click to select';
                    } catch (error) {
                        showMessage(uploadResult, error.message, true);
                    }
                    return;
                }

                // ✅ Single file
                if (fileInput.files.length === 1) {
                    showMessage(uploadResult, 'Uploading file...');
                    try {
                        const response = await fetch(`${API_BASE_URL}/upload`, { method: 'POST', body: formData });
                        if (!response.ok) throw new Error('File upload failed!');
                        const data = await response.json();
                        hideLoader();
                        // ✅ FIXED: Added API_BASE_URL to the view link
                        const fileName = formData.get('file').name;
                        const viewUrl = `${API_BASE_URL}/view/${data.code}`;
                        const successMessage = `<p>File '<strong>${fileName}</strong>' uploaded successfully! Your code is:</p><h2 style="letter-spacing: 2px;">${data.code}</h2><a href="${viewUrl}" target="_blank">Open Sharable Link</a>`;
                        showMessage(uploadResult, successMessage);
                        uploadForm.reset();
                        dropZone.querySelector('p').textContent = 'Drag & drop a file here or click to select';
                    } catch (error) {
                        showMessage(uploadResult, error.message, true);
                    }
                    return;
                }

                showMessage(uploadResult, 'Generating code...');
                try {
                    const response = await fetch(`${API_BASE_URL}/upload`, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('File upload failed!');
                    const data = await response.json();

                    hideLoader();
                    
                    currentCode = data.code;
                    originalText = textContent.value;
                    generateBtn.classList.add('hidden');
                    updateBtn.classList.remove('hidden');
                    updateBtn.disabled = true;
                    dropZone.classList.add('hidden');

                    // ✅ FIXED: Added API_BASE_URL to the view link
                    const viewUrl = `${API_BASE_URL}/view/${currentCode}`;
                    const successMessage = `<p>Success! Your share code is:</p><h2 style="letter-spacing: 2px;">${currentCode}</h2><a href="${viewUrl}" target="_blank">Open Sharable Link</a>`;
                    showMessage(uploadResult, successMessage);

                } catch (error) {
                    showMessage(uploadResult, error.message, true);
                }
            });
        });
        
        updateBtn.addEventListener('click', async () => {
            if (!currentCode || updateBtn.disabled) return;
            const newText = textContent.value;
            showMessage(uploadResult, 'Updating snippet...');

            try {
                const response = await fetch(`${API_BASE_URL}/update/${currentCode}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: newText })
                });
                if (!response.ok) throw new Error('Update failed!');
                
                originalText = newText;
                updateBtn.disabled = true;
                
                // ✅ FIXED: Added API_BASE_URL to the view link
                const viewUrl = `${API_BASE_URL}/view/${currentCode}`;
                const successMessage = `<p>Snippet updated successfully! Your code is:</p><h2 style="letter-spacing: 2px;">${currentCode}</h2><a href="${viewUrl}" target="_blank">Open Sharable Link</a>`;
                showMessage(uploadResult, successMessage);

            } catch (error) {
                showMessage(uploadResult, error.message, true);
            }
        });
    </script>
</body>
</html>