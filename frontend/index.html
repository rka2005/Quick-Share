<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Share</title>
    <link rel="icon" type="image/png" href="quick-share.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loaderContainer" class="loader-container hidden">
        <div class="book">
            <div class="book__pg-shadow"></div>
            <div class="book__pg"></div>
            <div class="book__pg book__pg--2"></div>
            <div class="book__pg book__pg--3"></div>
            <div class="book__pg book__pg--4"></div>
            <div class="book__pg book__pg--5"></div>
        </div>
    </div>

    <div class="container">
        <div class="theme-switcher-container">
            <label class="switch">
                <input id="themeToggle" type="checkbox">
                <div class="slider round">
                    <div class="sun-moon">
                        <svg id="moon-dot-1" class="moon-dot" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50"></circle></svg>
                        <svg id="moon-dot-2" class="moon-dot" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50"></circle></svg>
                        <svg id="moon-dot-3" class="moon-dot" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50"></circle></svg>
                    </div>
                    <div class="stars">
                        <svg id="star-1" class="star" viewBox="0 0 20 20"><path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path></svg>
                        <svg id="star-2" class="star" viewBox="0 0 20 20"><path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path></svg>
                        <svg id="star-3" class="star" viewBox="0 0 20 20"><path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path></svg>
                        <svg id="star-4" class="star" viewBox="0 0 20 20"><path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path></svg>
                    </div>
                </div>
            </label>
        </div>

        <div class="header">
            <h1>Quick Share</h1>
            <p>Share text snippets and files securely and ephemerally.</p>
        </div>

        <div id="contentView" class="hidden"></div>
        <div id="initialView">
            <div id="retrieveSection">
                <form id="retrieveForm">
                    <input type="text" id="codeInput" placeholder="Enter share code..." required style="text-transform: uppercase;">
                    <button type="submit">Get Content</button>
                </form>
                <div id="retrieveResult" class="hidden"></div>
            </div>
            <div id="shareSection" class="section">
                <form id="uploadForm">
                    <textarea id="textContent" name="text_content" rows="5" placeholder="Paste text snippet here..."></textarea>
                    <div id="dropZone" class="drop-zone">
                        <p><strong>Drag & drop a file here</strong> or click to select</p>
                        <input type="file" id="fileInput" name="file" class="hidden" multiple>
                    </div>
                    <button id="generateBtn" type="submit" style="margin-top: 20px;">Generate Code</button>
                    <button id="updateBtn" type="button" class="hidden" style="margin-top: 20px;" disabled>Update Text</button>
                </form>
                <div id="uploadResult" class="hidden"></div>
            </div>
        </div>
    </div>

    <footer>
        <p>¬© 2025 Quuick Share | All rights reserved.</p>
        <div class = "contact">
            <a href="mailto:rohitadak0@gmail.com">
                <img src="mail.png" class="contact-icon" alt="Mail">
            </a>
            <a href="tel:+918348765905">
                <img src="phone.png" class="contact-icon" alt="Phone">
            </a>
        </div>
    </footer>

    <script>
        const API_BASE_URL = "https://quick-share-xwhs.onrender.com";
        // ‚ú® --- 3. JAVASCRIPT FOR LOADER & THEME --- ‚ú®
        const loaderContainer = document.getElementById('loaderContainer');
        const themeToggle = document.getElementById('themeToggle');

        // Loader functions
        const showLoader = () => loaderContainer.classList.remove('hidden');
        const hideLoader = () => loaderContainer.classList.add('hidden');

        // Loader on page load
        document.addEventListener('DOMContentLoaded', () => {
            showLoader();
        });

        window.addEventListener('load', () => {
            hideLoader();
        });

        // Loader during async operations
        async function handleAsyncOperation(asyncFunc) {
            try {
                showLoader();
                await asyncFunc();
            } catch (err) {
                console.error(err);
            } finally {
                hideLoader();
            }
        }
        // Theme functions
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggle.checked = true;
            } else {
                document.body.classList.remove('dark-theme');
                themeToggle.checked = false;
            }
        };
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        
        // --- The rest of your original JavaScript is below ---
        
        const initialView = document.getElementById('initialView');
        const contentView = document.getElementById('contentView');
        const retrieveForm = document.getElementById('retrieveForm');
        const codeInput = document.getElementById('codeInput');
        const retrieveResult = document.getElementById('retrieveResult');
        const uploadForm = document.getElementById('uploadForm');
        const uploadResult = document.getElementById('uploadResult');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const textContent = document.getElementById('textContent');
        const generateBtn = document.getElementById('generateBtn');
        const updateBtn = document.getElementById('updateBtn');
        
        let currentCode = null;
        let originalText = "";

        function showInitialView() {
            initialView.classList.remove('hidden');
            contentView.classList.add('hidden');
            contentView.innerHTML = '';
            retrieveResult.classList.add('hidden');
            uploadResult.classList.add('hidden');
            codeInput.value = '';
            
            currentCode = null;
            originalText = "";
            uploadForm.reset();
            generateBtn.classList.remove('hidden');
            updateBtn.classList.add('hidden');
            dropZone.classList.remove('hidden');
            dropZone.querySelector('p').textContent = 'Drag & drop a file here or click to select';
        }
        
        function showContentView() {
            initialView.classList.add('hidden');
            contentView.classList.remove('hidden');
        }

        function showMessage(element, message, isError = false) {
            element.innerHTML = `<div class="result-message ${isError ? 'result-error' : 'result-success'}">${message}</div>`;
            element.classList.remove('hidden');
        }
        
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;

                const fileNames = Array.from(e.dataTransfer.files).map(f => f.name).join(', ');
                dropZone.querySelector('p').textContent = `${fileNames} selected`;

                textContent.value = ""; 
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                const fileNames = Array.from(fileInput.files).map(f => f.name).join(', ');
                dropZone.querySelector('p').textContent = `${fileNames} selected`;
                textContent.value = "";
            }
        });

        // ‚ú® HELPER: Force Download Function
        async function forceDownload(url, filename, btnElement) {
            const originalText = btnElement.textContent;
            btnElement.textContent = '‚è≥ Downloading...';
            btnElement.disabled = true;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network error');

                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Download failed:', error);
                // Fallback: open in new tab if fetch fails
                window.open(url, '_blank');
            } finally {
                btnElement.textContent = originalText;
                btnElement.disabled = false;
            }
        }
        
        retrieveForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const code = codeInput.value.trim().toUpperCase();
            if (!code) return;

            handleAsyncOperation(async () => {
                showMessage(retrieveResult, 'Searching...');
                try {
                    const response = await fetch(`${API_BASE_URL}/find_file/${code}`);
                    if (!response.ok) throw new Error('Code not found. Please check and try again.');
                    const data = await response.json();
                    hideLoader();
                    showContentView();

                    // üß© MULTIPLE FILES
                    if (data.type === 'multiple') {
                        contentView.innerHTML = `<h1>üìÅ Files for Code: ${code}</h1>`;

                        const grid = document.createElement('div');
                        grid.style.display = "grid";
                        grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(200px, 1fr))";
                        grid.style.gap = "20px";
                        grid.style.marginTop = "20px";

                        for (const f of data.files) {
                            const fileUrl = `${API_BASE_URL}/get_multiple/${code}/${f}`;
                            const ext = f.split('.').pop().toLowerCase();

                            const card = document.createElement('div');
                            card.style.border = "1px solid var(--glass-border)";
                            card.style.borderRadius = "12px";
                            card.style.padding = "10px";
                            card.style.textAlign = "center";
                            card.style.background = "var(--glass-bg)";
                            card.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
                            card.style.transition = "transform 0.2s ease";
                            card.onmouseenter = () => (card.style.transform = "scale(1.03)");
                            card.onmouseleave = () => (card.style.transform = "scale(1)");

                            // üñºÔ∏è Show image preview if image
                            if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                                const img = document.createElement('img');
                                img.src = fileUrl;
                                img.alt = f;
                                img.style.maxWidth = "100%";
                                img.style.borderRadius = "8px";
                                img.style.marginBottom = "8px";
                                card.appendChild(img);
                            } 
                            // üìÑ For text/pdf files, show an icon or small preview
                            else if (["txt", "md"].includes(ext)) {
                                const res = await fetch(fileUrl);
                                const text = await res.text();
                                const snippet = document.createElement('pre');
                                snippet.textContent = text.slice(0, 200) + (text.length > 200 ? "..." : "");
                                snippet.style.fontSize = "12px";
                                snippet.style.textAlign = "left";
                                snippet.style.whiteSpace = "pre-wrap";
                                snippet.style.maxHeight = "120px";
                                snippet.style.overflowY = "auto";
                                snippet.style.background = "rgba(255,255,255,0.05)";
                                snippet.style.padding = "8px";
                                snippet.style.borderRadius = "6px";
                                card.appendChild(snippet);
                            } 
                            // üìé For other file types
                            else {
                                const fileIcon = document.createElement('div');
                                fileIcon.textContent = "üìé";
                                fileIcon.style.fontSize = "32px";
                                fileIcon.style.marginBottom = "8px";
                                card.appendChild(fileIcon);
                            }

                            // Preview button
                            const previewBtn = document.createElement('button');
                            previewBtn.textContent = 'üëÅÔ∏è Preview';
                            previewBtn.className = 'button';
                            previewBtn.style.marginTop = "8px";
                            previewBtn.style.marginRight = "4px";
                            previewBtn.style.fontSize = "0.9em";
                            previewBtn.onclick = () => {
                                // Clear the content view and show preview
                                contentView.innerHTML = `<h1>File Preview</h1><p><strong>${f}</strong></p>`;
                                
                                if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                                    const img = document.createElement('img');
                                    img.src = fileUrl;
                                    img.style.maxWidth = "100%";
                                    img.style.borderRadius = "10px";
                                    img.style.marginBottom = "20px";
                                    contentView.appendChild(img);
                                } else if (ext === "pdf") {
                                    const embed = document.createElement('embed');
                                    embed.src = fileUrl;
                                    embed.type = "application/pdf";
                                    embed.width = "100%";
                                    embed.height = "500px";
                                    contentView.appendChild(embed);
                                } else if (["txt", "md"].includes(ext)) {
                                    fetch(fileUrl).then(res => res.text()).then(text => {
                                        const pre = document.createElement('pre');
                                        pre.textContent = text;
                                        pre.style.background = "#f8f8f8";
                                        pre.style.padding = "10px";
                                        pre.style.borderRadius = "8px";
                                        contentView.appendChild(pre);
                                    });
                                } else {
                                    const info = document.createElement('p');
                                    info.textContent = "Preview not available for this file type.";
                                    contentView.appendChild(info);
                                }

                                // Add download button
                                const dlBtn = document.createElement('button');
                                dlBtn.textContent = 'Download File';
                                dlBtn.classList.add('button');
                                dlBtn.style.marginTop = "15px";
                                dlBtn.addEventListener('click', () => {
                                    forceDownload(fileUrl, f, dlBtn);
                                });
                                contentView.appendChild(dlBtn);

                                // Add back button to return to grid view
                                const backToGridBtn = document.createElement('button');
                                backToGridBtn.textContent = 'Back to Files';
                                backToGridBtn.className = 'button button-secondary';
                                backToGridBtn.style.marginTop = '20px';
                                backToGridBtn.style.marginLeft = '10px';
                                backToGridBtn.onclick = () => {
                                    contentView.innerHTML = `<h1>üìÅ Files for Code: ${code}</h1>`;
                                    contentView.appendChild(grid);
                                    contentView.appendChild(fullView);
                                    contentView.appendChild(backBtn);
                                };
                                contentView.appendChild(backToGridBtn);
                            };
                            
                            // Download button
                            const downloadBtn = document.createElement('button');
                            downloadBtn.textContent = '‚¨áÔ∏è Download';
                            downloadBtn.className = 'button button-secondary';
                            downloadBtn.style.marginTop = "8px";
                            downloadBtn.style.fontSize = "0.9em";
                            downloadBtn.addEventListener('click', () => {
                                forceDownload(fileUrl, f, downloadBtn);
                            });
                            
                            // Filename display
                            const fileName = document.createElement('div');
                            fileName.textContent = f;
                            fileName.style.marginTop = "8px";
                            fileName.style.color = "var(--accent-color)";
                            fileName.style.overflow = "hidden";
                            fileName.style.textOverflow = "ellipsis";
                            fileName.style.whiteSpace = "nowrap";
                            
                            card.appendChild(fileName);
                            card.appendChild(previewBtn);
                            card.appendChild(downloadBtn);
                            grid.appendChild(card);
                        }

                        contentView.appendChild(grid);

                        const backBtn = document.createElement('button');
                        backBtn.textContent = 'Share or Get Another';
                        backBtn.className = 'button button-secondary';
                        backBtn.style.marginTop = '20px';
                        backBtn.onclick = showInitialView;
                        contentView.appendChild(backBtn);

                        return;
                    }

                    // üß© TEXT SNIPPET
                    if (data.type === 'text') {
                        const copyBtn = document.createElement('button');
                        copyBtn.textContent = 'Copy Text';
                        copyBtn.className = 'button copy-button';
                        copyBtn.addEventListener('click', () => {
                            navigator.clipboard.writeText(data.content).then(() => {
                                copyBtn.textContent = 'Copied!';
                                setTimeout(() => { copyBtn.textContent = 'Copy Text'; }, 2000);
                            });
                        });
                        contentView.appendChild(copyBtn);
                        const pre = document.createElement('pre');
                        pre.textContent = data.content;
                        contentView.appendChild(pre);
                    }

                    // üß© SINGLE FILE
                    else if (data.type === 'file') {
                        const fileUrl = `${API_BASE_URL}/get/${data.filename}`;
                        const ext = data.filename.split('.').pop().toLowerCase();

                        contentView.innerHTML = `<h1>File Preview</h1><p><strong>${data.filename}</strong></p>`;

                        if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                            const img = document.createElement('img');
                            img.src = fileUrl;
                            img.style.maxWidth = "100%";
                            img.style.borderRadius = "10px";
                            img.style.marginBottom = "20px";
                            contentView.appendChild(img);
                        } else if (ext === "pdf") {
                            const embed = document.createElement('embed');
                            embed.src = fileUrl;
                            embed.type = "application/pdf";
                            embed.width = "100%";
                            embed.height = "500px";
                            contentView.appendChild(embed);
                        } else if (["txt", "md"].includes(ext)) {
                            const res = await fetch(fileUrl);
                            const text = await res.text();
                            const pre = document.createElement('pre');
                            pre.textContent = text;
                            pre.style.background = "#f8f8f8";
                            pre.style.padding = "10px";
                            pre.style.borderRadius = "8px";
                            contentView.appendChild(pre);
                        } else {
                            const info = document.createElement('p');
                            info.textContent = "Preview not available for this file type.";
                            contentView.appendChild(info);
                        }

                        const downloadBtn = document.createElement('button');
                        downloadBtn.textContent = 'Download File';
                        downloadBtn.classList.add('button');
                        downloadBtn.style.marginTop = "15px";
                        downloadBtn.addEventListener('click', () => {
                            forceDownload(fileUrl, data.filename, downloadBtn);
                        });
                        contentView.appendChild(downloadBtn);
                    }

                    // ‚úÖ BACK BUTTON
                    const backBtn = document.createElement('button');
                    backBtn.textContent = 'Share or Get Another';
                    backBtn.className = 'button button-secondary';
                    backBtn.style.marginTop = '20px';
                    backBtn.onclick = showInitialView;
                    contentView.appendChild(backBtn);

                } catch (error) {
                    showMessage(retrieveResult, error.message, true);
                }
            });
        });

        textContent.addEventListener('input', () => {
            if (currentCode) {
                const isModified = textContent.value !== originalText;
                updateBtn.disabled = !isModified;
            }
            if(textContent.value) {
                fileInput.value = '';
                dropZone.querySelector('p').textContent = 'Drag & drop a file here or click to select';
            }
        });
        
        uploadForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(uploadForm);

        if (!formData.get('text_content') && !formData.get('file')?.name) {
            showMessage(uploadResult, 'Please add text or a file to share.', true);
            return;
        }

        handleAsyncOperation(async () => {
            // ‚úÖ Multiple files
            if (fileInput.files.length > 1) {
            showMessage(uploadResult, 'Uploading multiple files...');
            const multiFormData = new FormData();
            for (let i = 0; i < fileInput.files.length; i++) {
                multiFormData.append('files', fileInput.files[i]);
            }

            try {
                const res = await fetch(`${API_BASE_URL}/upload_multiple`, {
                method: 'POST',
                body: multiFormData,
                });

                if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`Multiple file upload failed: ${errorText}`);
                }

                const data = await res.json();
                hideLoader();

                const viewUrl = `${API_BASE_URL}/view/${data.code}`;
                const fileList = data.files.map(f => `<li>${f}</li>`).join('');

                const successMessage = `
                <p>‚úÖ Uploaded <strong>${data.files.length}</strong> files successfully!</p>
                <p>Your share code:</p>
                <h2 style="letter-spacing: 2px;">${data.code}</h2>
                <ul>${fileList}</ul>
                <a href="${viewUrl}" target="_blank">üîó Open Sharable Link</a>
                `;
                showMessage(uploadResult, successMessage);

                uploadForm.reset();
                dropZone.querySelector('p').textContent = 'Drag & drop a file here or click to select';
            } catch (error) {
                console.error(error);
                showMessage(uploadResult, error.message, true);
            }
            return;
            }

            // ‚úÖ Single file upload
            if (fileInput.files.length === 1) {
            showMessage(uploadResult, 'Uploading file...');
            try {
                const res = await fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                body: formData
                });
                if (!res.ok) throw new Error('File upload failed!');

                const data = await res.json();
                hideLoader();

                const fileName = formData.get('file').name;
                const viewUrl = `${API_BASE_URL}/view/${data.code}`;
                const successMessage = `
                <p>‚úÖ File '<strong>${fileName}</strong>' uploaded successfully!</p>
                <p>Your share code:</p>
                <h2 style="letter-spacing: 2px;">${data.code}</h2>
                <a href="${viewUrl}" target="_blank">üîó Open Sharable Link</a>
                `;
                showMessage(uploadResult, successMessage);

                uploadForm.reset();
                dropZone.querySelector('p').textContent = 'Drag & drop a file here or click to select';
            } catch (error) {
                showMessage(uploadResult, error.message, true);
            }
            return;
            }

            // ‚úÖ Text-only upload
            showMessage(uploadResult, 'Generating code...');
            try {
            const res = await fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                body: formData
            });
            if (!res.ok) throw new Error('Text upload failed!');

            const data = await res.json();
            hideLoader();

            currentCode = data.code;
            originalText = textContent.value;
            generateBtn.classList.add('hidden');
            updateBtn.classList.remove('hidden');
            updateBtn.disabled = true;
            dropZone.classList.add('hidden');

            const viewUrl = `${API_BASE_URL}/view/${currentCode}`;
            const successMessage = `
                <p>‚úÖ Success! Your share code is:</p>
                <h2 style="letter-spacing: 2px;">${currentCode}</h2>
                <a href="${viewUrl}" target="_blank">üîó Open Sharable Link</a>
            `;
            showMessage(uploadResult, successMessage);
            } catch (error) {
            showMessage(uploadResult, error.message, true);
            }
        });
        });

        
        updateBtn.addEventListener('click', async () => {
            if (!currentCode || updateBtn.disabled) return;
            const newText = textContent.value;
            showMessage(uploadResult, 'Updating snippet...');

            try {
                const response = await fetch(`${API_BASE_URL}/update/${currentCode}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: newText })
                });
                if (!response.ok) throw new Error('Update failed!');
                
                originalText = newText;
                updateBtn.disabled = true;
                
                // ‚úÖ FIXED: Added API_BASE_URL to the view link
                const viewUrl = `${API_BASE_URL}/view/${currentCode}`;
                const successMessage = `<p>Snippet updated successfully! Your code is:</p><h2 style="letter-spacing: 2px;">${currentCode}</h2><a href="${viewUrl}" target="_blank">Open Sharable Link</a>`;
                showMessage(uploadResult, successMessage);

            } catch (error) {
                showMessage(uploadResult, error.message, true);
            }
        });
    </script>
</body>
</html>